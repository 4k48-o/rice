# åç«¯å¼€å‘è®¡åˆ’

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
> **çŠ¶æ€**: æ‰§è¡Œä¸­  
> **é¡¹ç›®**: FastAndtAdmin Backend  
> **æ›´æ–°æ—¶é—´**: 2025-12-07

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [å¼€å‘é˜¶æ®µ](#2-å¼€å‘é˜¶æ®µ)
3. [æŠ€æœ¯é€‰å‹è¯´æ˜](#3-æŠ€æœ¯é€‰å‹è¯´æ˜)
4. [å¼€å‘è§„èŒƒ](#4-å¼€å‘è§„èŒƒ)
5. [ä»»åŠ¡åˆ†é…å»ºè®®](#5-ä»»åŠ¡åˆ†é…å»ºè®®)
6. [é‡Œç¨‹ç¢‘](#6-é‡Œç¨‹ç¢‘)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç›®æ ‡

å¼€å‘ä¸€ä¸ª**é«˜æ€§èƒ½ã€é«˜å¯æ‰©å±•ã€å®‰å…¨å¯é **çš„å¤šç§Ÿæˆ·ä¼ä¸šç®¡ç†ç³»ç»Ÿåç«¯APIæœåŠ¡,æ”¯æŒ:
- å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- åŸºäºRBACçš„æƒé™æ§åˆ¶
- RESTful APIè®¾è®¡
- å¼‚æ­¥é«˜å¹¶å‘å¤„ç†
- å®Œæ•´çš„å®¡è®¡æ—¥å¿—

### 1.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Python | 3.10+ | ç¼–ç¨‹è¯­è¨€ |
| FastAPI | 0.109+ | Webæ¡†æ¶ |
| SQLAlchemy | 2.0+ | ORM |
| PostgreSQL | 15+ | ä¸»æ•°æ®åº“ |
| Redis | 7+ | ç¼“å­˜/ä¼šè¯ |
| Alembic | 1.13+ | æ•°æ®åº“è¿ç§» |
| Pydantic | 2.5+ | æ•°æ®éªŒè¯ |

### 1.3 é¡¹ç›®çŠ¶æ€

âœ… **å·²å®Œæˆ**:
- é¡¹ç›®ç»“æ„æ­å»º
- æ ¸å¿ƒé…ç½®æ¨¡å—
- æ•°æ®åº“è¿æ¥(å¼‚æ­¥)
- JWTè®¤è¯æ¡†æ¶
- åŸºç¡€æ¨¡å‹å®šä¹‰
- APIè·¯ç”±æ¡†æ¶

â³ **è¿›è¡Œä¸­**:
- ä¸šåŠ¡é€»è¾‘å®ç°

ğŸ“‹ **å¾…å¼€å‘**:
- [ ] æƒé™æ§åˆ¶(RBACç»†èŠ‚)
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬å®Œå–„
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡æå‡
- [ ] é›†æˆæµ‹è¯•å®Œå–„


---

## 2. å¼€å‘é˜¶æ®µ

### é˜¶æ®µä¸€: åŸºç¡€è®¾æ–½ (ç¬¬1-2å‘¨) âœ…

**ç›®æ ‡**: æ­å»ºé¡¹ç›®åŸºç¡€æ¡†æ¶

- [x] åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
- [x] é…ç½®ç®¡ç†(Pydantic Settings)
- [x] æ•°æ®åº“è¿æ¥(å¼‚æ­¥SQLAlchemy)
- [x] JWTè®¤è¯æ¡†æ¶
- [x] åŸºç¡€æ¨¡å‹å®šä¹‰
- [x] APIè·¯ç”±æ¡†æ¶
- [x] ä¸­é—´ä»¶é…ç½®(CORSã€æ—¥å¿—)
- [x] æ•°æ®åº“ã€ç¼“å­˜ã€æ—¥å¿—æ•°æ®åº“çš„é…ç½® (Review: Redis & Postgres Configured)
- [x] é›ªèŠ±IDç”Ÿæˆå™¨
- [x] ç»Ÿä¸€å¼‚å¸¸å¤„ç†



**äº¤ä»˜ç‰©**:
- âœ… å¯è¿è¡Œçš„FastAPIåº”ç”¨
- âœ… å®Œæ•´çš„é¡¹ç›®ç»“æ„
- â³ æ•°æ®åº“è¿ç§»è„šæœ¬

---

### é˜¶æ®µäºŒ: è®¤è¯æˆæƒæ¨¡å— (ç¬¬3-4å‘¨)

**ç›®æ ‡**: å®ç°å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæˆæƒç³»ç»Ÿ

#### 2.1 æ•°æ®æ¨¡å‹

- [x] å®Œå–„Useræ¨¡å‹
- [x] åˆ›å»ºTenantæ¨¡å‹
- [x] åˆ›å»ºRoleæ¨¡å‹
- [x] åˆ›å»ºPermissionæ¨¡å‹
- [x] åˆ›å»ºDepartmentæ¨¡å‹
- [x] åˆ›å»ºå…³è”è¡¨(UserRole, RolePermission)

#### 2.2 è®¤è¯åŠŸèƒ½

- [x] ç”¨æˆ·ç™»å½•
  - [x] ç”¨æˆ·åå¯†ç éªŒè¯
  - [x] ç§Ÿæˆ·éªŒè¯
  - [x] éªŒè¯ç ç”Ÿæˆå’ŒéªŒè¯ (åŸºç¡€)
  - [x] Tokenç”Ÿæˆ(access + refresh)
  - [x] ç™»å½•æ—¥å¿—è®°å½• (åŸºç¡€)
- [x] Tokenåˆ·æ–°
  - [x] Refresh tokenéªŒè¯
  - [x] æ–°tokenç”Ÿæˆ
- [x] ç”¨æˆ·ç™»å‡º
  - [x] Tokenå¤±æ•ˆ(Redis)
  - [x] ä¼šè¯æ¸…ç† (å•ç‚¹ç™»å½•å®ç°)
- [x] è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  - [x] ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  - [x] è§’è‰²åˆ—è¡¨
  - [x] æƒé™åˆ—è¡¨
- [x] è·å–ç”¨æˆ·èœå•
  - [x] æ ¹æ®æƒé™ç”Ÿæˆèœå•æ ‘
  - [x] èœå•æ’åº


#### 2.3 æƒé™æ§åˆ¶

- [x] æƒé™è£…é¥°å™¨
  - [x] `@require_permissions("user:list")`
  - [x] `@require_roles("admin")`
- [x] æ•°æ®æƒé™è¿‡æ»¤
  - [x] å…¨éƒ¨æ•°æ®
  - [x] æœ¬éƒ¨é—¨æ•°æ®
  - [x] æœ¬éƒ¨é—¨åŠä¸‹çº§æ•°æ®
  - [x] ä»…æœ¬äººæ•°æ®
- [x] ç§Ÿæˆ·éš”ç¦»ä¸­é—´ä»¶
  - [x] è‡ªåŠ¨æ³¨å…¥tenant_idè¿‡æ»¤
  - [x] è¶…çº§ç®¡ç†å‘˜ä¾‹å¤–å¤„ç†


**äº¤ä»˜ç‰©**:
- å®Œæ•´çš„è®¤è¯API
- æƒé™æ§åˆ¶ç³»ç»Ÿ
- ç§Ÿæˆ·éš”ç¦»æœºåˆ¶

---

### é˜¶æ®µä¸‰: ç”¨æˆ·ç®¡ç†æ¨¡å— (ç¬¬5-6å‘¨)

**ç›®æ ‡**: å®ç°ç”¨æˆ·ã€è§’è‰²ã€éƒ¨é—¨çš„å®Œæ•´CRUD

#### 3.1 ç”¨æˆ·ç®¡ç†

- [x] ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢
  - [x] åˆ†é¡µæŸ¥è¯¢
  - [x] å¤šæ¡ä»¶è¿‡æ»¤(å…³é”®å­—ã€éƒ¨é—¨ã€çŠ¶æ€ã€æ—¶é—´èŒƒå›´)
  - [x] æ’åº
- [x] ç”¨æˆ·è¯¦æƒ…æŸ¥è¯¢
  - [x] åŸºæœ¬ä¿¡æ¯
  - [x] è§’è‰²åˆ—è¡¨
  - [x] éƒ¨é—¨ä¿¡æ¯
- [x] åˆ›å»ºç”¨æˆ·
  - [x] æ•°æ®éªŒè¯(Pydantic + å¯†ç å¤æ‚åº¦)
  - [x] ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥
  - [x] é‚®ç®±/æ‰‹æœºå·å”¯ä¸€æ€§æ£€æŸ¥
  - [x] å¯†ç åŠ å¯†
  - [x] åˆ†é…è§’è‰²
- [x] æ›´æ–°ç”¨æˆ·
  - [x] åŸºæœ¬ä¿¡æ¯æ›´æ–°
  - [x] è§’è‰²æ›´æ–°
  - [x] çŠ¶æ€æ›´æ–°
- [x] åˆ é™¤ç”¨æˆ·(è½¯åˆ é™¤)
  - [x] æƒé™æ£€æŸ¥
  - [x] å…³è”æ•°æ®å¤„ç†
- [ ] æ‰¹é‡åˆ é™¤ç”¨æˆ·
- [x] é‡ç½®å¯†ç 
  - [x] ç®¡ç†å‘˜é‡ç½®
  - [x] å¼ºåˆ¶ä¸‹æ¬¡ç™»å½•ä¿®æ”¹ (I18næ”¯æŒ)
- [x] ä¿®æ”¹ä¸ªäººå¯†ç 
  - [x] æ—§å¯†ç éªŒè¯
  - [x] æ–°å¯†ç å¼ºåº¦æ£€æŸ¥
- [x] æ›´æ–°ä¸ªäººä¿¡æ¯

- [ ] å¯¼å‡ºç”¨æˆ·
  - [ ] Excelå¯¼å‡º
  - [ ] æ•°æ®è„±æ•

#### 3.2 è§’è‰²ç®¡ç†

- [x] è§’è‰²åˆ—è¡¨æŸ¥è¯¢
- [x] è§’è‰²è¯¦æƒ…æŸ¥è¯¢(å«æƒé™åˆ—è¡¨)
- [x] åˆ›å»ºè§’è‰²
  - [x] åˆ†é…æƒé™
  - [x] æ•°æ®æƒé™èŒƒå›´è®¾ç½®
- [x] æ›´æ–°è§’è‰²
- [x] åˆ é™¤è§’è‰²
  - [x] æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ä½¿ç”¨
- [x] è·å–æƒé™æ ‘
  - [x] èœå•æƒé™
  - [x] æŒ‰é’®æƒé™
  - [x] APIæƒé™

#### 3.3 éƒ¨é—¨ç®¡ç†

- [x] éƒ¨é—¨æ ‘æŸ¥è¯¢
  - [x] é€’å½’æŸ¥è¯¢
  - [x] æ ‘å½¢ç»“æ„æ„å»º
- [x] éƒ¨é—¨åˆ—è¡¨æŸ¥è¯¢(æ‰å¹³)
- [x] éƒ¨é—¨è¯¦æƒ…æŸ¥è¯¢
- [x] åˆ›å»ºéƒ¨é—¨
  - [x] çˆ¶çº§éƒ¨é—¨éªŒè¯
  - [x] éƒ¨é—¨ç¼–ç å”¯ä¸€æ€§
- [x] æ›´æ–°éƒ¨é—¨
- [x] åˆ é™¤éƒ¨é—¨
  - [x] æ£€æŸ¥æ˜¯å¦æœ‰å­éƒ¨é—¨
  - [x] æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·

**äº¤ä»˜ç‰©**:
- ç”¨æˆ·ç®¡ç†å®Œæ•´API
- è§’è‰²ç®¡ç†å®Œæ•´API
- éƒ¨é—¨ç®¡ç†å®Œæ•´API

---

### é˜¶æ®µå››: ç§Ÿæˆ·ç®¡ç†æ¨¡å— (ç¬¬7å‘¨)

**ç›®æ ‡**: å®ç°ç§Ÿæˆ·å’Œå¥—é¤ç®¡ç†

#### 4.1 ç§Ÿæˆ·ç®¡ç†

- [ ] ç§Ÿæˆ·åˆ—è¡¨æŸ¥è¯¢
- [ ] ç§Ÿæˆ·è¯¦æƒ…æŸ¥è¯¢
- [ ] åˆ›å»ºç§Ÿæˆ·
  - [ ] ç§Ÿæˆ·ç¼–ç å”¯ä¸€æ€§
  - [ ] åŸŸåå”¯ä¸€æ€§
  - [ ] åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®(é»˜è®¤è§’è‰²ã€æƒé™)
- [ ] æ›´æ–°ç§Ÿæˆ·
  - [ ] åŸºæœ¬ä¿¡æ¯
  - [ ] é…é¢è®¾ç½®
  - [ ] åˆ°æœŸæ—¶é—´
- [ ] åˆ é™¤ç§Ÿæˆ·(è½¯åˆ é™¤)
- [ ] ä¿®æ”¹ç§Ÿæˆ·çŠ¶æ€
  - [ ] å¯ç”¨/ç¦ç”¨
  - [ ] è¿‡æœŸå¤„ç†

#### 4.2 ç§Ÿæˆ·å¥—é¤ç®¡ç†

- [ ] å¥—é¤åˆ—è¡¨æŸ¥è¯¢
- [ ] å¥—é¤è¯¦æƒ…æŸ¥è¯¢
- [ ] åˆ›å»ºå¥—é¤
- [ ] æ›´æ–°å¥—é¤
- [ ] åˆ é™¤å¥—é¤

**äº¤ä»˜ç‰©**:
- ç§Ÿæˆ·ç®¡ç†API
- å¥—é¤ç®¡ç†API

---

### é˜¶æ®µäº”: ç³»ç»Ÿé…ç½®æ¨¡å— (ç¬¬8å‘¨)

**ç›®æ ‡**: å®ç°å­—å…¸ã€é…ç½®ã€é€šçŸ¥ç­‰ç³»ç»ŸåŠŸèƒ½

#### 5.1 å­—å…¸ç®¡ç†

- [ ] å­—å…¸ç±»å‹CRUD
- [ ] å­—å…¸æ•°æ®CRUD
- [ ] æ ¹æ®ç±»å‹è·å–å­—å…¸æ•°æ®(å…¬å¼€æ¥å£)
- [ ] å­—å…¸ç¼“å­˜(Redis)

#### 5.2 ç³»ç»Ÿé…ç½®

- [ ] é…ç½®åˆ—è¡¨æŸ¥è¯¢(æŒ‰åˆ†ç»„)
- [ ] æ›´æ–°é…ç½®
- [ ] é…ç½®ç¼“å­˜(Redis)

#### 5.3 é€šçŸ¥å…¬å‘Š

- [ ] å…¬å‘Šåˆ—è¡¨æŸ¥è¯¢
- [ ] å…¬å‘Šè¯¦æƒ…æŸ¥è¯¢
- [ ] åˆ›å»ºå…¬å‘Š
- [ ] æ›´æ–°å…¬å‘Š
- [ ] åˆ é™¤å…¬å‘Š
- [ ] å‘å¸ƒå…¬å‘Š
- [ ] æ’¤å›å…¬å‘Š

**äº¤ä»˜ç‰©**:
- å­—å…¸ç®¡ç†API
- ç³»ç»Ÿé…ç½®API
- é€šçŸ¥å…¬å‘ŠAPI

---

### é˜¶æ®µå…­: æ—¥å¿—æŸ¥è¯¢æ¨¡å— (ç¬¬9å‘¨)

**ç›®æ ‡**: å®ç°æ“ä½œæ—¥å¿—ã€ç™»å½•æ—¥å¿—ã€åœ¨çº¿ç”¨æˆ·æŸ¥è¯¢

#### 6.1 æ“ä½œæ—¥å¿—

- [ ] æ“ä½œæ—¥å¿—ä¸­é—´ä»¶
  - [ ] è‡ªåŠ¨è®°å½•APIè°ƒç”¨
  - [ ] è®°å½•è¯·æ±‚å‚æ•°(è„±æ•)
  - [ ] è®°å½•å“åº”çŠ¶æ€
  - [ ] è®°å½•æ‰§è¡Œæ—¶é—´
  - [ ] å¼‚æ­¥å†™å…¥(é¿å…å½±å“æ€§èƒ½)
- [ ] æ“ä½œæ—¥å¿—åˆ—è¡¨æŸ¥è¯¢
  - [ ] åˆ†é¡µæŸ¥è¯¢
  - [ ] å¤šæ¡ä»¶è¿‡æ»¤
  - [ ] æ—¶é—´èŒƒå›´æŸ¥è¯¢
- [ ] æ“ä½œæ—¥å¿—è¯¦æƒ…æŸ¥è¯¢

#### 6.2 ç™»å½•æ—¥å¿—

- [ ] ç™»å½•æ—¥å¿—è®°å½•(åœ¨ç™»å½•æ¥å£ä¸­)
- [ ] ç™»å½•æ—¥å¿—åˆ—è¡¨æŸ¥è¯¢
- [ ] å¤±è´¥ç™»å½•ç»Ÿè®¡(å®‰å…¨ç›‘æ§)

#### 6.3 åœ¨çº¿ç”¨æˆ·

- [ ] åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢(ä»Redis)
- [ ] å¼ºåˆ¶ä¸‹çº¿
  - [ ] åˆ é™¤Redisä¼šè¯
  - [ ] Tokenå¤±æ•ˆ

**äº¤ä»˜ç‰©**:
- æ“ä½œæ—¥å¿—API
- ç™»å½•æ—¥å¿—API
- åœ¨çº¿ç”¨æˆ·API

---

### é˜¶æ®µä¸ƒ: æ–‡ä»¶ç®¡ç†æ¨¡å— (ç¬¬10å‘¨)

**ç›®æ ‡**: å®ç°æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤

#### 7.1 æ–‡ä»¶ä¸Šä¼ 

- [ ] æ–‡ä»¶ä¸Šä¼ æ¥å£
  - [ ] æ–‡ä»¶å¤§å°é™åˆ¶
  - [ ] æ–‡ä»¶ç±»å‹é™åˆ¶
  - [ ] æ–‡ä»¶åå¤„ç†(UUID)
  - [ ] å­˜å‚¨è·¯å¾„è§„åˆ’(æŒ‰æ—¥æœŸ)
  - [ ] å…ƒæ•°æ®ä¿å­˜(æ•°æ®åº“)
- [ ] æ”¯æŒå¤šç§å­˜å‚¨
  - [ ] æœ¬åœ°å­˜å‚¨
  - [ ] OSS(å¯é€‰)
  - [ ] S3(å¯é€‰)

#### 7.2 æ–‡ä»¶ä¸‹è½½

- [ ] æ–‡ä»¶ä¸‹è½½æ¥å£
  - [ ] æƒé™æ£€æŸ¥
  - [ ] æµå¼ä¸‹è½½

#### 7.3 æ–‡ä»¶ç®¡ç†

- [ ] æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢
- [ ] åˆ é™¤æ–‡ä»¶
  - [ ] ç‰©ç†åˆ é™¤æ–‡ä»¶
  - [ ] åˆ é™¤æ•°æ®åº“è®°å½•

**äº¤ä»˜ç‰©**:
- æ–‡ä»¶ä¸Šä¼ API
- æ–‡ä»¶ä¸‹è½½API
- æ–‡ä»¶ç®¡ç†API

---

### é˜¶æ®µå…«: æµ‹è¯•ä¸ä¼˜åŒ– (ç¬¬11-12å‘¨)

**ç›®æ ‡**: å®Œå–„æµ‹è¯•,æ€§èƒ½ä¼˜åŒ–

#### 8.1 å•å…ƒæµ‹è¯•

- [ ] Coreæ¨¡å—æµ‹è¯•
  - [ ] Configæµ‹è¯•
  - [ ] Securityæµ‹è¯•(JWTã€å¯†ç )
  - [ ] Databaseæµ‹è¯•
- [ ] Modelsæµ‹è¯•
  - [ ] æ¨¡å‹åˆ›å»ºæµ‹è¯•
  - [ ] å…³è”å…³ç³»æµ‹è¯•
- [ ] Servicesæµ‹è¯•
  - [ ] ä¸šåŠ¡é€»è¾‘æµ‹è¯•
  - [ ] Mockæ•°æ®åº“

#### 8.2 é›†æˆæµ‹è¯•

- [ ] APIæµ‹è¯•
  - [ ] è®¤è¯æµç¨‹æµ‹è¯•
  - [ ] ç”¨æˆ·ç®¡ç†æµ‹è¯•
  - [ ] è§’è‰²æƒé™æµ‹è¯•
  - [ ] ç§Ÿæˆ·éš”ç¦»æµ‹è¯•
- [ ] ä½¿ç”¨pytest + httpx
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%

#### 8.3 æ€§èƒ½ä¼˜åŒ–

- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
  - [ ] æ·»åŠ å¿…è¦ç´¢å¼•
  - [ ] N+1æŸ¥è¯¢ä¼˜åŒ–
  - [ ] ä½¿ç”¨select_related/joinedload
- [ ] Redisç¼“å­˜
  - [ ] å­—å…¸æ•°æ®ç¼“å­˜
  - [ ] é…ç½®ç¼“å­˜
  - [ ] ç”¨æˆ·æƒé™ç¼“å­˜
- [ ] æ¥å£æ€§èƒ½æµ‹è¯•
  - [ ] ä½¿ç”¨Locustå‹æµ‹
  - [ ] å“åº”æ—¶é—´ < 100ms(P95)
  - [ ] QPS > 1000

#### 8.4 ä»£ç è´¨é‡

- [ ] ä»£ç æ ¼å¼åŒ–(black)
- [ ] ä»£ç æ£€æŸ¥(ruff)
- [ ] ç±»å‹æ£€æŸ¥(mypy)
- [ ] å®‰å…¨æ£€æŸ¥(bandit)

**äº¤ä»˜ç‰©**:
- å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- ä»£ç è´¨é‡æŠ¥å‘Š

---

### é˜¶æ®µä¹: æ–‡æ¡£ä¸éƒ¨ç½² (ç¬¬13å‘¨)

**ç›®æ ‡**: å®Œå–„æ–‡æ¡£,å‡†å¤‡éƒ¨ç½²

#### 9.1 æ–‡æ¡£å®Œå–„

- [ ] APIæ–‡æ¡£(Swaggerè‡ªåŠ¨ç”Ÿæˆ)
- [ ] æ•°æ®åº“è¿ç§»æ–‡æ¡£
- [ ] éƒ¨ç½²æ–‡æ¡£
- [ ] è¿ç»´æ‰‹å†Œ
- [ ] å¼€å‘è€…æŒ‡å—

#### 9.2 éƒ¨ç½²å‡†å¤‡

- [ ] Dockerfileç¼–å†™
- [ ] docker-compose.yml
- [ ] Kubernetesé…ç½®(å¯é€‰)
- [ ] CI/CDé…ç½®
  - [ ] GitHub Actions
  - [ ] è‡ªåŠ¨æµ‹è¯•
  - [ ] è‡ªåŠ¨éƒ¨ç½²

#### 9.3 ç›‘æ§å‘Šè­¦

- [ ] PrometheusæŒ‡æ ‡æš´éœ²
- [ ] Grafanaä»ªè¡¨æ¿
- [ ] æ—¥å¿—æ”¶é›†(ELK/Loki)
- [ ] é”™è¯¯å‘Šè­¦(Sentry)

**äº¤ä»˜ç‰©**:
- å®Œæ•´æ–‡æ¡£
- éƒ¨ç½²è„šæœ¬
- ç›‘æ§é…ç½®

---

## 3. æŠ€æœ¯é€‰å‹è¯´æ˜

### 3.1 ä¸ºä»€ä¹ˆé€‰æ‹©FastAPI?

âœ… **ä¼˜åŠ¿**:
1. **é«˜æ€§èƒ½**: åŸºäºStarletteå’ŒPydantic,æ€§èƒ½æ¥è¿‘Node.jså’ŒGo
2. **å¼‚æ­¥æ”¯æŒ**: åŸç”Ÿasync/await,é€‚åˆé«˜å¹¶å‘åœºæ™¯
3. **è‡ªåŠ¨æ–‡æ¡£**: è‡ªåŠ¨ç”ŸæˆOpenAPI(Swagger)æ–‡æ¡£
4. **ç±»å‹æç¤º**: å®Œæ•´çš„ç±»å‹æç¤ºæ”¯æŒ,IDEå‹å¥½
5. **æ•°æ®éªŒè¯**: Pydanticè‡ªåŠ¨éªŒè¯è¯·æ±‚æ•°æ®
6. **ç°ä»£åŒ–**: Python 3.10+ç‰¹æ€§,ç±»å‹æ³¨è§£

### 3.2 ä¸ºä»€ä¹ˆé€‰æ‹©SQLAlchemy 2.0?

âœ… **ä¼˜åŠ¿**:
1. **å¼‚æ­¥æ”¯æŒ**: AsyncSession,é€‚åˆFastAPI
2. **ç±»å‹å®‰å…¨**: 2.0ç‰ˆæœ¬æ”¹è¿›äº†ç±»å‹æç¤º
3. **æ€§èƒ½ä¼˜åŒ–**: æŸ¥è¯¢æ€§èƒ½æå‡
4. **æˆç†Ÿç¨³å®š**: Pythonæœ€æµè¡Œçš„ORM
5. **çµæ´»æ€§**: æ”¯æŒåŸç”ŸSQLå’ŒORMæ··ç”¨

### 3.3 ä¸ºä»€ä¹ˆé€‰æ‹©PostgreSQL?

âœ… **ä¼˜åŠ¿**:
1. **åŠŸèƒ½å¼ºå¤§**: æ”¯æŒJSONBã€å…¨æ–‡æœç´¢ã€åˆ†åŒºè¡¨
2. **æ€§èƒ½ä¼˜ç§€**: é€‚åˆOLTPåœºæ™¯
3. **å¯é æ€§é«˜**: ACIDå®Œæ•´æ”¯æŒ
4. **æ‰©å±•æ€§å¥½**: æ”¯æŒæ°´å¹³æ‰©å±•(Citus)
5. **å¼€æºå…è´¹**: æ— è®¸å¯è¯è´¹ç”¨

### 3.4 å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»æ–¹æ¡ˆ

âœ… **æ–¹æ¡ˆè¯´æ˜**:
æœ¬é¡¹ç›®é‡‡ç”¨**å…±äº«æ•°æ®åº“ï¼Œå…±äº«Schemaï¼Œå…±äº«æ•°æ®è¡¨**ï¼ˆDiscriminator Columnï¼‰çš„é€»è¾‘éš”ç¦»æ¨¡å¼ã€‚

1.  **æ•°æ®åº“å±‚è®¾è®¡**:
    *   **é‰´åˆ«åˆ—**: æ‰€æœ‰ä¸šåŠ¡è¡¨ç»§æ‰¿ `TenantMixin`ï¼Œè‡ªåŠ¨åŒ…å« `tenant_id` (BigInt) å­—æ®µã€‚
    *   **ç´¢å¼•ç­–ç•¥**: æ ¸å¿ƒæŸ¥è¯¢å¿…é¡»åŒ…å« `tenant_id`ï¼Œå¹¶åœ¨ (tenant_id, id) æˆ– (tenant_id, created_at) ä¸Šå»ºç«‹å¤åˆç´¢å¼•ã€‚

2.  **åº”ç”¨å±‚éš”ç¦»**:
    *   **ä¸­é—´ä»¶æ‹¦æˆª**: `TenantMiddleware` è§£æè¯·æ±‚å¤´/åŸŸåè·å– `tenant_id`ï¼Œå­˜å…¥ `contextvars`ã€‚
    *   **å…¨å±€ä¸Šä¸‹æ–‡**: åœ¨æ•´ä¸ª Request-Response ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œé€šè¿‡ `app.core.context` è®¿é—®å½“å‰ç§Ÿæˆ·ä¿¡æ¯ã€‚
    *   **è‡ªåŠ¨è¿‡æ»¤**: Service å±‚ CRUD æ“ä½œè‡ªåŠ¨æ³¨å…¥ `tenant_id` è¿‡æ»¤æ¡ä»¶ï¼Œé˜²æ­¢è·¨ç§Ÿæˆ·æ•°æ®è®¿é—®ã€‚

3.  **ç‰¹æƒè±å…**:
    *   ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ (`user_type=0`) å¯é€šè¿‡ç‰¹å®šæ¥å£è®¿é—®è·¨ç§Ÿæˆ·æ•°æ®ï¼Œç”¨äºè¿ç»´ç®¡ç†ã€‚

4.  **æ•°æ®å®‰å…¨**:
    *   **é€»è¾‘åˆ é™¤**: ç»“åˆ `is_deleted` è½¯åˆ é™¤ï¼Œç¡®ä¿æ•°æ®å¯æ¢å¤æ€§ã€‚
    *   **å¤‡ä»½æ¢å¤**: æ”¯æŒæŒ‰ `tenant_id` å¯¼å‡ºæ•°æ®è¿›è¡Œå•ç§Ÿæˆ·å¤‡ä»½ï¼ˆè§„åˆ’ä¸­ï¼‰ã€‚

### 3.5 éƒ¨é—¨çº§æ•°æ®æƒé™éš”ç¦»æ–¹æ¡ˆ

âœ… **æ–¹æ¡ˆè¯´æ˜**:
åœ¨ç§Ÿæˆ·éš”ç¦»çš„åŸºç¡€ä¸Šï¼Œå®ç°åŸºäº**è§’è‰²æ•°æ®èŒƒå›´**ï¼ˆData Scopeï¼‰çš„ç»†ç²’åº¦æ•°æ®æƒé™æ§åˆ¶ã€‚

1.  **æ•°æ®èŒƒå›´å®šä¹‰ (DataScope)**:
    *   `1: ALL` (å…¨éƒ¨æ•°æ®æƒé™): å¯æŸ¥çœ‹æœ¬ç§Ÿæˆ·ä¸‹æ‰€æœ‰æ•°æ®ã€‚
    *   `2: CUSTOM` (è‡ªå®šä¹‰æ•°æ®æƒé™): å¯æŸ¥çœ‹æŒ‡å®šéƒ¨é—¨çš„æ•°æ®ã€‚
    *   `3: DEPT` (æœ¬éƒ¨é—¨æ•°æ®æƒé™): ä»…å¯æŸ¥çœ‹ç”¨æˆ·å½“å‰æ‰€å±éƒ¨é—¨çš„æ•°æ®ã€‚
    *   `4: DEPT_AND_CHILD` (æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™): å¯æŸ¥çœ‹ç”¨æˆ·æ‰€å±éƒ¨é—¨åŠå…¶å­éƒ¨é—¨çš„æ•°æ®ã€‚
    *   `5: SELF` (ä»…æœ¬äººæ•°æ®æƒé™): ä»…å¯æŸ¥çœ‹ç”±ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„æ•°æ® (`created_by = user.id`)ã€‚

2.  **å®ç°æœºåˆ¶**:
    *   **é‰´æƒå­—æ®µ**: ä¸šåŠ¡è¡¨åŒ…å« `dept_id` (éƒ¨é—¨ID) å’Œ `created_by` (åˆ›å»ºäººID) å­—æ®µã€‚
    *   **Permissionè£…é¥°å™¨**:
        *   ä½¿ç”¨ `@require_permissions("user:list")` ç­‰è£…é¥°å™¨æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨æ•°æ®æƒé™è¿‡æ»¤é€»è¾‘ã€‚
    *   **è¿‡æ»¤é€»è¾‘ (Serviceå±‚)**:
        *   è·å–å½“å‰ç”¨æˆ·çš„è§’è‰²åˆ—è¡¨ï¼Œè®¡ç®—å¹¶é›†çš„**æœ€å¤§æ•°æ®èŒƒå›´**ã€‚
        *   æ ¹æ®è®¡ç®—å‡ºçš„èŒƒå›´ï¼Œè‡ªåŠ¨å‘ SQLAlchemy æŸ¥è¯¢è¯­å¥æ·»åŠ  `WHERE` æ¡ä»¶ã€‚
            *   ä¾‹: `WHERE dept_id IN (...)` æˆ– `WHERE created_by = ...`

3.  **é…ç½®æ–¹å¼**:
    *   åœ¨**è§’è‰²ç®¡ç†**ä¸­é…ç½®è¯¥è§’è‰²çš„æ•°æ®èŒƒå›´ã€‚
    *   å¦‚æœæ˜¯è‡ªå®šä¹‰æƒé™ï¼Œéœ€è¿›ä¸€æ­¥é€‰æ‹©å…·ä½“çš„**éƒ¨é—¨åˆ—è¡¨**ã€‚

---

## 4. å¼€å‘è§„èŒƒ

### 4.1 ä»£ç è§„èŒƒ

#### 4.1.1 å‘½åè§„èŒƒ

```python
# æ–‡ä»¶å: å°å†™+ä¸‹åˆ’çº¿
user_service.py

# ç±»å: å¤§é©¼å³°
class UserService:
    pass

# å‡½æ•°å: å°å†™+ä¸‹åˆ’çº¿
def get_user_by_id():
    pass

# å¸¸é‡: å¤§å†™+ä¸‹åˆ’çº¿
MAX_PAGE_SIZE = 100

# ç§æœ‰å˜é‡/æ–¹æ³•: å‰ç¼€ä¸‹åˆ’çº¿
_internal_cache = {}
```

#### 4.1.2 ç±»å‹æ³¨è§£

```python
# å¿…é¡»ä½¿ç”¨ç±»å‹æ³¨è§£
def get_user(user_id: int) -> Optional[User]:
    pass

# å¤æ‚ç±»å‹
from typing import List, Dict, Optional

def get_users() -> List[User]:
    pass
```

#### 4.1.3 æ–‡æ¡£å­—ç¬¦ä¸²

```python
def create_user(username: str, password: str) -> User:
    """
    Create a new user.
    
    Args:
        username: User's username
        password: User's password (will be hashed)
        
    Returns:
        User: Created user object
        
    Raises:
        ValueError: If username already exists
    """
    pass
```

### 4.2 Gitè§„èŒƒ

#### 4.2.1 åˆ†æ”¯ç­–ç•¥

- `main`: ç”Ÿäº§ç¯å¢ƒåˆ†æ”¯
- `develop`: å¼€å‘åˆ†æ”¯
- `feature/xxx`: åŠŸèƒ½åˆ†æ”¯
- `bugfix/xxx`: ä¿®å¤åˆ†æ”¯
- `hotfix/xxx`: ç´§æ€¥ä¿®å¤åˆ†æ”¯

#### 4.2.2 Commitè§„èŒƒ

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Typeç±»å‹**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: ä¿®å¤bug
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼(ä¸å½±å“åŠŸèƒ½)
- `refactor`: é‡æ„
- `test`: æµ‹è¯•
- `chore`: æ„å»º/å·¥å…·å˜åŠ¨

**ç¤ºä¾‹**:
```
feat(auth): add JWT token refresh endpoint

- Implement refresh token validation
- Generate new access token
- Update user last login time

Closes #123
```

### 4.3 æ•°æ®åº“è§„èŒƒ

#### 4.3.1 è¿ç§»è§„èŒƒ

```bash
# åˆ›å»ºè¿ç§»æ—¶å¿…é¡»æ·»åŠ æè¿°æ€§æ¶ˆæ¯
alembic revision --autogenerate -m "add user table"

# ä¸è¦æ‰‹åŠ¨ä¿®æ”¹è¿ç§»æ–‡ä»¶çš„up/downé€»è¾‘
# å¦‚æœéœ€è¦ä¿®æ”¹,åˆ é™¤è¿ç§»æ–‡ä»¶é‡æ–°ç”Ÿæˆ
```

#### 4.3.2 æŸ¥è¯¢ä¼˜åŒ–

```python
# âŒ é¿å…N+1æŸ¥è¯¢
users = await db.execute(select(User))
for user in users:
    roles = await db.execute(select(Role).where(Role.user_id == user.id))

# âœ… ä½¿ç”¨joinedload
users = await db.execute(
    select(User).options(joinedload(User.roles))
)
```

### 4.4 APIè§„èŒƒ

#### 4.4.1 è·¯ç”±å‘½å

```python
# âœ… ä½¿ç”¨å¤æ•°åè¯
@router.get("/users")
@router.get("/users/{id}")

# âŒ é¿å…åŠ¨è¯
@router.get("/get-users")  # é”™è¯¯
```

#### 4.4.2 å“åº”æ ¼å¼

```python
# å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„å“åº”æ ¼å¼
from app.schemas import Response, DataResponse

@router.get("/users/{id}", response_model=DataResponse[User])
async def get_user(id: int):
    user = await user_service.get_by_id(id)
    return {
        "code": 200,
        "message": "success",
        "data": user,
        "timestamp": int(time.time())
    }
```

---

## 5. ä»»åŠ¡åˆ†é…å»ºè®®

### 5.1 å›¢é˜Ÿè§’è‰²

| è§’è‰² | èŒè´£ | äººæ•° |
|------|------|------|
| æŠ€æœ¯è´Ÿè´£äºº | æ¶æ„è®¾è®¡ã€ä»£ç å®¡æŸ¥ã€æŠ€æœ¯éš¾ç‚¹æ”»å…³ | 1 |
| åç«¯å¼€å‘ | ä¸šåŠ¡é€»è¾‘å®ç°ã€APIå¼€å‘ | 2-3 |
| æµ‹è¯•å·¥ç¨‹å¸ˆ | æµ‹è¯•ç”¨ä¾‹ç¼–å†™ã€æµ‹è¯•æ‰§è¡Œ | 1 |
| DevOps | éƒ¨ç½²ã€ç›‘æ§ã€CI/CD | 1 |

### 5.2 ä»»åŠ¡åˆ†é…ç¤ºä¾‹

**å¼€å‘äººå‘˜A**:
- è®¤è¯æˆæƒæ¨¡å—
- ç”¨æˆ·ç®¡ç†æ¨¡å—
- æµ‹è¯•ç¼–å†™

**å¼€å‘äººå‘˜B**:
- è§’è‰²æƒé™æ¨¡å—
- éƒ¨é—¨ç®¡ç†æ¨¡å—
- ç§Ÿæˆ·ç®¡ç†æ¨¡å—

**å¼€å‘äººå‘˜C**:
- ç³»ç»Ÿé…ç½®æ¨¡å—
- æ—¥å¿—æŸ¥è¯¢æ¨¡å—
- æ–‡ä»¶ç®¡ç†æ¨¡å—

---

## 6. é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ | äº¤ä»˜ç‰© | çŠ¶æ€ |
|--------|------|--------|------|
| M1: é¡¹ç›®åˆå§‹åŒ– | ç¬¬2å‘¨ | é¡¹ç›®æ¡†æ¶ã€åŸºç¡€é…ç½® | âœ… å·²å®Œæˆ |
| M2: è®¤è¯æˆæƒ | ç¬¬4å‘¨ | ç™»å½•ã€æƒé™æ§åˆ¶ | âœ… å·²å®Œæˆ |
| M3: ç”¨æˆ·ç®¡ç† | ç¬¬6å‘¨ | ç”¨æˆ·/è§’è‰²/éƒ¨é—¨CRUD | âœ… å·²å®Œæˆ (åŒ…æ‹¬èœå•) |
| M4: ç§Ÿæˆ·ç®¡ç† | ç¬¬7å‘¨ | ç§Ÿæˆ·/å¥—é¤ç®¡ç† | ğŸ“‹ å¾…å¼€å§‹ |
| M5: ç³»ç»Ÿé…ç½® | ç¬¬8å‘¨ | å­—å…¸/é…ç½®/é€šçŸ¥ | ğŸ“‹ å¾…å¼€å§‹ |
| M6: æ—¥å¿—æŸ¥è¯¢ | ç¬¬9å‘¨ | æ“ä½œ/ç™»å½•/åœ¨çº¿ç”¨æˆ· | ğŸ“‹ å¾…å¼€å§‹ |
| M7: æ–‡ä»¶ç®¡ç† | ç¬¬10å‘¨ | æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ | ğŸ“‹ å¾…å¼€å§‹ |
| M8: æµ‹è¯•ä¼˜åŒ– | ç¬¬12å‘¨ | æµ‹è¯•è¦†ç›–ã€æ€§èƒ½ä¼˜åŒ– | ğŸ“‹ å¾…å¼€å§‹ |
| M9: ä¸Šçº¿å‡†å¤‡ | ç¬¬13å‘¨ | æ–‡æ¡£ã€éƒ¨ç½² | ğŸ“‹ å¾…å¼€å§‹ |

---

## é™„å½•

### A. å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uvicorn app.main:app --reload

# è¿è¡Œæµ‹è¯•
pytest

# ä»£ç æ ¼å¼åŒ–
black app/

# ä»£ç æ£€æŸ¥
ruff check app/

# ç±»å‹æ£€æŸ¥
mypy app/

# æ•°æ®åº“è¿ç§»
alembic upgrade head

# ç”Ÿæˆè¿ç§»
alembic revision --autogenerate -m "description"
```

### B. ç¯å¢ƒå˜é‡è¯´æ˜

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| DATABASE_URL | æ•°æ®åº“è¿æ¥ | postgresql+asyncpg://user:pass@localhost/db |
| SECRET_KEY | JWTå¯†é’¥ | éšæœºå­—ç¬¦ä¸²(è‡³å°‘32ä½) |
| REDIS_URL | Redisè¿æ¥ | redis://localhost:6379/0 |
| APP_ENV | è¿è¡Œç¯å¢ƒ | development/production |

### C. å‚è€ƒèµ„æ–™

- [FastAPIå®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemy 2.0æ–‡æ¡£](https://docs.sqlalchemy.org/en/20/)
- [Pydanticæ–‡æ¡£](https://docs.pydantic.dev/)
- [Alembicæ–‡æ¡£](https://alembic.sqlalchemy.org/)

---

**æ–‡æ¡£ç»“æŸ**
